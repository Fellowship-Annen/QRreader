<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Android / PWA -->
  <link rel="manifest" href="./manifest.json">
  <!-- iOS -->
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <!-- favicon -->
  <link rel="icon" href="./favicon.ico">
  <link rel="icon" sizes="192x192" href="./icon-192.png">
  <link rel="icon" sizes="512x512" href="./icon-512.png">
  <meta name="theme-color" content="#ffffff">

  <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆAndroidã®ä¸Šéƒ¨ãƒãƒ¼è‰²ï¼‰ -->
  <meta name="theme-color" content="#ffffff">
  <title>ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆQRèª­å–</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 0; }
    .wrap { padding: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; font-size: 16px; }
    .status { margin-top: 10px; padding: 10px; background: #f3f3f3; border-radius: 8px; white-space: pre-wrap; }
    .card { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    .grid { display: grid; grid-template-columns: 110px 1fr; gap: 6px 10px; align-items: baseline; }
    .label { color: #555; }
    .value { font-weight: 600; }
    .weight { font-size: 20px; font-weight: 800; }
    .hidden { display: none !important; }

    /* camera layer */
    #cameraLayer {
      position: fixed; inset: 0; background: #000; z-index: 9999;
      display: flex; flex-direction: column;
    }
    #video {
      width: 100%; height: 100%; object-fit: cover; flex: 1;
      background: #000;
    }
    #camBar {
      position: absolute; left: 0; right: 0; bottom: 0;
      display: flex; gap: 10px; padding: 12px;
      background: linear-gradient(transparent, rgba(0,0,0,.65));
    }
    #camBar button { flex: 1; }
    #hint {
      position: absolute; left: 12px; right: 12px; top: 12px;
      color: #fff; background: rgba(0,0,0,.45);
      padding: 10px; border-radius: 10px; font-size: 14px;
    }
    /* è¿½åŠ :20260212 */
    .simTitle{
      margin-top: 10px;
      padding: 8px 10px;
      background: #f7f7f7;
      border-radius: 10px;
      font-weight: 800;
    }
    .simList{
      margin-top: 10px;
      display: grid;
      gap: 6px;
    }
    .simRow{
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 0.7fr;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fff;
    }
    .simHead{
      font-size: 12px;
      color: #666;
    }
    .simVal{
      font-weight: 700;
    }
    .simTotal{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #fff6d6;
      font-weight: 900;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="wrap" id="mainLayer">
    <h2 style="margin: 0 0 10px;">ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆQRèª­å–</h2>

    <div class="row">
      <button id="btnStartCam" disabled>ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
      <button id="btnReloadCsv">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
    </div>

    <div class="status" id="status">èµ·å‹•ä¸­â€¦</div>

    <div class="card hidden" id="resultCard">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <div>
          <div style="font-size:14px; color:#666;">ç®¡ç†ç•ªå·</div>
          <div class="value" id="resId" style="font-size:18px;"></div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:14px; color:#666;">é‡é‡ï¼ˆgï¼‰</div>
          <div class="weight" id="resWeight">-</div>
        </div>
      </div>
      <hr style="border:none; border-top:1px solid #eee; margin:10px 0;">
      <div class="grid">
        <div class="label">ãƒ¡ãƒ¼ã‚«ãƒ¼</div><div class="value" id="resMaker">-</div>
        <div class="label">æ¯æ</div><div class="value" id="resBase">-</div>
        <div class="label">è‰²</div><div class="value" id="resColor">-</div>
        <div class="label">ä¿ç®¡å ´æ‰€</div><div class="value" id="resLoc">-</div>
      </div>
      <!-- åŒä¸€ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆä¸€è¦§ è¿½åŠ :20260212 -->
      <div id="similarSection" class="hidden" style="margin-top:14px;">
        <div class="simTitle">åŒã˜ç¨®é¡ã®ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆ</div>

        <div id="similarList" class="simList"></div>

        <div class="simTotal">
          é‡é‡ åˆè¨ˆï¼ˆgï¼‰: <span id="similarTotalWeight">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Camera layer -->
  <div id="cameraLayer" class="hidden">
    <video id="video" playsinline></video>
    <div id="hint">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å†™ã—ã¦ãã ã•ã„ï¼ˆèªè­˜ã—ãŸã‚‰è‡ªå‹•ã§åœæ­¢ã—ã¾ã™ï¼‰</div>
    <div id="camBar">
      <button id="btnStopCam">ã‚«ãƒ¡ãƒ©åœæ­¢</button>
    </div>
    <canvas id="canvas" class="hidden"></canvas>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /**********************
     * è¨­å®šï¼ˆã‚ãªãŸã®æ¡ä»¶ï¼‰
     **********************/
    const ENTRY_KEY = "entry.268306040";

    // CSV å–å¾—URLï¼ˆexport æ–¹å¼ï¼‰
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/15UGqdqOwVQNx9qY02HtZIaqrD6Kd1dwmWuj4p3EGIGg/export?format=csv&gid=93776902";

    // ãƒ«ãƒ¼ãƒ—é–“éš”ï¼ˆmsï¼‰: 200ã€œ500 ã®ç¯„å›²
    const SCAN_INTERVAL_MS = 300;

    /**********************
     * çŠ¶æ…‹
     **********************/
    let csvRows = [];          // [{ç®¡ç†ç•ªå·:..., ãƒ¡ãƒ¼ã‚«ãƒ¼:..., ...}, ...]
    let csvLoaded = false;

    let stream = null;
    let scanning = false;
    let scanTimer = null;

    /**********************
     * UIå‚ç…§
     **********************/
    const statusEl = document.getElementById("status");
    const btnStartCam = document.getElementById("btnStartCam");
    const btnReloadCsv = document.getElementById("btnReloadCsv");

    const cameraLayer = document.getElementById("cameraLayer");
    const mainLayer = document.getElementById("mainLayer");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const btnStopCam = document.getElementById("btnStopCam");

    const resultCard = document.getElementById("resultCard");
    const resId = document.getElementById("resId");
    const resMaker = document.getElementById("resMaker");
    const resBase = document.getElementById("resBase");
    const resColor = document.getElementById("resColor");
    const resLoc = document.getElementById("resLoc");
    const resWeight = document.getElementById("resWeight");//è¿½åŠ :20260212
    const similarSection = document.getElementById("similarSection");//è¿½åŠ :20260212
    const similarList = document.getElementById("similarList");//è¿½åŠ :20260212
    const similarTotalWeight = document.getElementById("similarTotalWeight");//è¿½åŠ :20260212


    /**********************
     * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
     **********************/
    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function showResultCard(show) {
      resultCard.classList.toggle("hidden", !show);
    }

    function sanitizeId(id) {
      // å¿µã®ãŸã‚å‰å¾Œç©ºç™½é™¤å»ï¼ˆå®Œå…¨ä¸€è‡´å‰æã ã‘ã©å®‰å…¨ç­–ï¼‰
      return String(id ?? "").trim();
    }

    function sanitizeWeight(w) {
      // æ•°å­—ãƒ»å°æ•°ç‚¹ãƒ»ã‚«ãƒ³ãƒä»¥å¤–ã‚’é™¤å»ï¼ˆå¿µã®ãŸã‚ï¼‰
      const s = String(w ?? "").trim();
      return s.replace(/[^0-9.,]/g, "");
    }

    function isProbablyMobile() {
      // ã–ã£ãã‚Šåˆ¤å®šï¼ˆè¦ä»¶ï¼šã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä¸­å¿ƒï¼‰
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    function extractEntryValueFromUrl(urlStr) {
      try {
        const u = new URL(urlStr);
        const v = u.searchParams.get(ENTRY_KEY);
        return v ? v : null;
      } catch {
        return null;
      }
    }
    //ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆä¸€è¦§è¿½åŠ é–¢æ•°ã€€è¿½åŠ :20260212
    function getField(row, candidates) {
      for (const k of candidates) {
        if (row && row[k] != null && String(row[k]).trim() !== "") return row[k];
      }
      return "";
    }

    function normText(v) {
      return String(v ?? "").trim();
    }

    function parseWeightToNumber(v) {
      // æ•°å­—/å°æ•°ç‚¹/ã‚«ãƒ³ãƒä»¥å¤–é™¤å» â†’ ã‚«ãƒ³ãƒé™¤å» â†’ æ•°å€¤åŒ–
      const s = sanitizeWeight(v);        // æ—¢å­˜ã® sanitizeWeight ã‚’åˆ©ç”¨
      const n = parseFloat(s.replace(/,/g, ""));
      return Number.isFinite(n) ? n : 0;
    }


    function findRowById(id) {
      const target = sanitizeId(id);
      // ç®¡ç†ç•ªå·åˆ—ã§å®Œå…¨ä¸€è‡´ï¼ˆtrimè¾¼ã¿ï¼‰
      return csvRows.find(r => sanitizeId(r["ç®¡ç†ç•ªå·(åŠè§’)"]) === target) || null;
    }

    function renderRow(id, row) {
      resId.textContent = sanitizeId(id);

      // è¡¨ç¤ºé …ç›®
      resMaker.textContent = row["ãƒ¡ãƒ¼ã‚«ãƒ¼"] ?? "-";
      resBase.textContent  = row["æ¯æ(ãƒ™ãƒ¼ã‚¹)"] ?? row["æ¯æ"] ?? "-"; // å¿µã®ãŸã‚è¡¨è¨˜ã‚†ã‚Œå¸å
      resColor.textContent = row["è‰²"] ?? "-";
      resLoc.textContent   = row["ä¿ç®¡å ´æ‰€"] ?? "-";

      // å¿…é ˆï¼šé‡é‡
      const w = sanitizeWeight(row["é‡é‡ï¼ˆï½‡ï¼‰"] ?? row["é‡é‡(g)"] ?? row["é‡é‡"] ?? "");
      resWeight.textContent = w ? w : "ï¼ˆæœªè¨­å®šï¼‰";

      showResultCard(true);
      renderSimilarList(id, row);//è¿½åŠ :20260212

    }

    /**********************
     * CSVèª­ã¿è¾¼ã¿
     **********************/
    async function loadCsv() {
      csvLoaded = false;
      btnStartCam.disabled = true;
      showResultCard(false);

      setStatus("CSVã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦");

      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("CSVå–å¾—å¤±æ•—: HTTP " + res.status);
        const text = await res.text();

        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true
        });

        if (parsed.errors && parsed.errors.length) {
          console.warn(parsed.errors);
        }

        csvRows = parsed.data || [];
        csvLoaded = true;
        btnStartCam.disabled = false;

        setStatus(
          "CSVå–å¾—OK âœ…\n" +
          `ä»¶æ•°: ${csvRows.length}\n` +
          (isProbablyMobile() ? "ç«¯æœ«: ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š" : "ç«¯æœ«: PCåˆ¤å®šï¼ˆå‹•ä½œã¯ã—ã¾ã™ï¼‰")
        );
      } catch (e) {
        console.error(e);
        setStatus(
          "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ âŒ\n" +
          "ãƒãƒƒãƒˆæ¥ç¶šã‚„å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n" +
          "ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€ã‚’æŠ¼ã—ã¦å†è©¦è¡Œã§ãã¾ã™ã€‚"
        );
      }
    }

    /**********************
     * ã‚«ãƒ¡ãƒ©èµ·å‹•/åœæ­¢
     **********************/
    async function startCamera() {
      if (!csvLoaded) {
        setStatus("å…ˆã«CSVå–å¾—ãŒå¿…è¦ã§ã™ã€‚");
        return;
      }

      // ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã‚‹ã‹
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆgetUserMediaéå¯¾å¿œï¼‰");
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });

        video.srcObject = stream;
        await video.play();

        // layeråˆ‡ã‚Šæ›¿ãˆ
        cameraLayer.classList.remove("hidden");
        mainLayer.classList.add("hidden");

        scanning = true;
        loopScan();

      } catch (e) {
        console.error(e);
        setStatus("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚„HTTPSã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function stopCamera() {
      scanning = false;
      if (scanTimer) {
        clearTimeout(scanTimer);
        scanTimer = null;
      }

      if (video) {
        try { video.pause(); } catch {}
        video.srcObject = null;
      }

      if (stream) {
        for (const t of stream.getTracks()) t.stop();
        stream = null;
      }

      // layeråˆ‡ã‚Šæ›¿ãˆ
      cameraLayer.classList.add("hidden");
      mainLayer.classList.remove("hidden");
    }

    function loopScan() {
      if (!scanning) return;

      // videoãŒã¾ã æº–å‚™ã§ãã¦ãªã„å ´åˆã¯å¾…ã¤
      if (video.readyState < 2) {
        scanTimer = setTimeout(loopScan, SCAN_INTERVAL_MS);
        return;
      }

      const w = video.videoWidth;
      const h = video.videoHeight;

      if (w === 0 || h === 0) {
        scanTimer = setTimeout(loopScan, SCAN_INTERVAL_MS);
        return;
      }

      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      ctx.drawImage(video, 0, 0, w, h);

      const img = ctx.getImageData(0, 0, w, h);
      const code = jsQR(img.data, w, h);

      if (code && code.data) {
        const urlStr = code.data;
        const id = extractEntryValueFromUrl(urlStr);

        // èªè­˜ã—ãŸã‚‰è‡ªå‹•åœæ­¢ï¼ˆä»•æ§˜ï¼‰
        stopCamera();

        if (!id) {
          setStatus("èªè­˜ã§ããªã„QRã§ã™ï¼ˆå¿…è¦ãªã‚¯ã‚¨ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰");
          showResultCard(false);
          return;
        }

        const row = findRowById(id);
        if (!row) {
          setStatus(`ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç®¡ç†ç•ªå·: ${sanitizeId(id)}ï¼‰`);
          showResultCard(false);
          return;
        }

        setStatus(`æ¤œç´¢OK âœ…ï¼ˆç®¡ç†ç•ªå·: ${sanitizeId(id)}ï¼‰`);
        renderRow(id, row);
        return;
      }

      scanTimer = setTimeout(loopScan, SCAN_INTERVAL_MS);
    }

    /**********************
     * ã‚¤ãƒ™ãƒ³ãƒˆ
     **********************/
    btnStartCam.addEventListener("click", startCamera);
    btnStopCam.addEventListener("click", () => {
      stopCamera();
      setStatus("ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
    });
    btnReloadCsv.addEventListener("click", loadCsv);

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadCsv();

    //åŒä¸€ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºé–¢æ•°ã‚’è¿½åŠ :20260212
    // ã¤ã„ã§ã«æ­£è¦åŒ–ã‚’å°‘ã—å¼·ã‚ã‚‹ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹å¯¾ç­–ãªã©ï¼‰
    function normText(v) {
      return String(v ?? "")
        .replace(/\u3000/g, " ")   // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹â†’åŠè§’
        .replace(/\s+/g, " ")     // é€£ç¶šç©ºç™½ã‚’1ã¤ã«
        .trim();
    }

    function renderSimilarList(baseId, baseRow) {
      // åŸºæº–è¡Œã®ç‰¹å¾´ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
      const baseMaker = normText(getField(baseRow, ["ãƒ¡ãƒ¼ã‚«ãƒ¼"]));
      const baseBase  = normText(getField(baseRow, ["æ¯æ(ãƒ™ãƒ¼ã‚¹)", "æ¯æ"]));
      const baseColor = normText(getField(baseRow, ["è‰²"]));

      // åŸºæº–è¡Œã®é‡é‡ï¼ˆåˆè¨ˆã«å«ã‚ã‚‹ï¼‰
      const baseWeightRaw = getField(baseRow, ["é‡é‡ï¼ˆï½‡ï¼‰", "é‡é‡(g)", "é‡é‡"]);
      let total = parseWeightToNumber(baseWeightRaw);

      // åŒä¸€æ¡ä»¶ã®è¡Œã‚’æŠ½å‡ºï¼ˆãŸã ã—åŸºæº–è¡Œã¯ä¸€è¦§ã‹ã‚‰é™¤å¤–ï¼‰
      const matches = csvRows.filter(r => {
        const id = sanitizeId(getField(r, ["ç®¡ç†ç•ªå·(åŠè§’)", "ç®¡ç†ç•ªå·"]));
        if (id === sanitizeId(baseId)) return false;

        const maker = normText(getField(r, ["ãƒ¡ãƒ¼ã‚«ãƒ¼"]));
        const mat   = normText(getField(r, ["æ¯æ(ãƒ™ãƒ¼ã‚¹)", "æ¯æ"]));
        const color = normText(getField(r, ["è‰²"]));

        const wRaw = getField(r, ["é‡é‡ï¼ˆï½‡ï¼‰", "é‡é‡(g)", "é‡é‡"]);
        const wNum = parseWeightToNumber(wRaw);

        // ğŸ”¹ æ¡ä»¶è¿½åŠ ï¼šé‡é‡ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã ã‘
        return maker === baseMaker &&
               mat === baseBase &&
               color === baseColor &&
               wNum > 0;
      });


      // âœ… ã“ã“ã‹ã‚‰è¡¨ç¤º
      similarList.innerHTML = "";
      similarSection.classList.remove("hidden");

      // âœ… â€œãƒ’ãƒƒãƒˆæ•°â€ã‚’å¿…ãšå‡ºã™ï¼ˆã¾ãšåˆ‡ã‚Šåˆ†ã‘æœ€å„ªå…ˆï¼‰
      setStatus(
        `æ¤œç´¢OK âœ…ï¼ˆç®¡ç†ç•ªå·: ${sanitizeId(baseId)}ï¼‰\n` +
        `åŒç¨®ãƒ’ãƒƒãƒˆ: ${matches.length}ä»¶`
      );

      if (matches.length === 0) {
        // 0ä»¶ã§ã‚‚å‹•ã„ã¦ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«å‡ºã™
        const line = document.createElement("div");
        line.className = "simRow";
        line.innerHTML = `
          <div class="simVal">è©²å½“ãªã—</div>
          <div class="simVal">-</div>
          <div class="simVal">-</div>
        `;
        similarList.appendChild(line);
        similarTotalWeight.textContent = String(total); // åˆè¨ˆã¯åŸºæº–è¡Œã®ã¿
        return;
      }

      for (const r of matches) {
        const id = sanitizeId(getField(r, ["ç®¡ç†ç•ªå·(åŠè§’)", "ç®¡ç†ç•ªå·"]));
        const loc = normText(getField(r, ["ä¿ç®¡å ´æ‰€"]));
        const wRaw = getField(r, ["é‡é‡ï¼ˆï½‡ï¼‰", "é‡é‡(g)", "é‡é‡"]);
        const wDisp = sanitizeWeight(wRaw);

        total += parseWeightToNumber(wRaw);

        const line = document.createElement("div");
        line.className = "simRow";
        line.innerHTML = `
          <div class="simVal">${id || "-"}</div>
          <div class="simVal">${loc || "-"}</div>
          <div class="simVal">${wDisp || "-"}</div>
        `;
        similarList.appendChild(line);
      }

      similarTotalWeight.textContent = String(total);
    }



  </script>
</body>
</html>
